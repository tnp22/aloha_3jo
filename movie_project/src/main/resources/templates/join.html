<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layout/layout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íšŒì› ê°€ì…</title>
    <link rel="stylesheet" href="/css/join.css">
</head>
<body layout:fragment="content">
    <div class="title">
        <h5 style="color: white;">íšŒì›ê°€ì…</h5>
    </div>
    <form id="form" action="/join" method="post" class="needs-validation" enctype="multipart/form-data" onsubmit="return checkSubmit(event)">
        <!-- CSRF TOKEN -->
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">


                <!-- íšŒì›ê°€ì… í¼ -->
        <div class="form-container">
            <div class="text-center">
                <img th:src="@{/image(id='C:/upload/vora_purple_black.png')}" style="width: 105px; height: 40px;">
            </div>
            <div class="mb-4">
                <label for="name" class="form-label">ì´ë¦„</label>
                <input type="text" class="form-control" id="name" name="name" placeholder="ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" required>
            </div>
            <div class="mb-4" id="box-id">
                <label for="username" class="form-label">ì•„ì´ë””</label>
                <div class="d-flex align-items-center">
                    <input type="text" class="form-control me-2" style="flex: 1;" id="username" name="username" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”" required>
                    <button type="button" class="btn btn-secondary" style="flex: 0 0 20%;" onclick="checkId(true)">ì¤‘ë³µí™•ì¸</button>
                </div>
            </div>
            <div class="mb-2">
                <label for="password" class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" class="form-control" id="password" name="password" placeholder="ì„¤ì •í•˜ì‹¤ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”" required>
            </div>
            <div class="mb-4">
                <input type="password" class="form-control" id="passwordCheck" placeholder="ì„¤ì •í•˜ì‹¤ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”" required>
                <p class="alert-text" id="errorMessage"></p>
            </div>
            <div class="mb-4">
                <label for="email" class="form-label">ì´ë©”ì¼</label>
                <input type="email" class="form-control" id="email" name="email" placeholder="ë“±ë¡í•˜ì‹¤ ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" required>
            </div>
            <div class="text-center">
                <button type="submit" style="width: 150px;" class="btn btn-purple">íšŒì› ê°€ì…</button>
            </div>
        </div>
            <!-- <div class="profile-image-container">
                <div class="profile-image" id="profileImage">
                  <span style="font-size: 50px;"></span>
                </div>
            </div>
            <div class="profile-upload-btn mb-4">
                <label for="fileInput" class="btn">ì´ë¯¸ì§€ ë“±ë¡</label>
                <input type="file" name="file" id="fileInput" accept="image/*">
            </div> -->

    </form>

    <script>
        // const fileInput = document.getElementById('fileInput');
        // const profileImage = document.getElementById('profileImage');
        // ğŸ’ CRSF TOKEN
        const csrfToken = "[[${_csrf.token}]]"
        const password = document.getElementById('password');
        const passwordCheck = document.getElementById('passwordCheck');
        const errorMessage = document.getElementById('errorMessage');

        // ë¹„ë°€ë²ˆí˜¸ í™•ì¸
        function validatePasswords() {
            if (password.value !== passwordCheck.value) {
                passwordCheck.style.border = "1px solid red"
                errorMessage.textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ë‹¤ë¦…ë‹ˆë‹¤. í™•ì¸í•´ì£¼ì„¸ìš”.";
                return false;
            } else {
                passwordCheck.style.border = "1px solid #583BBF"
                errorMessage.textContent = ""; // ë©”ì‹œì§€ ì´ˆê¸°í™”
                return true;
            }
        }
        // ì…ë ¥ í•„ë“œì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        passwordCheck.addEventListener('blur', validatePasswords);

        // // í”„ë¡œí•„ ì´ë¯¸ì§€ ì¶”ê°€
        // fileInput.addEventListener('change', function(event) {
        //     const file = event.target.files[0];

        //     if (file) {
        //         const reader = new FileReader();

        //         reader.onload = function(e) {
        //         // ì´ë¯¸ì§€ íƒœê·¸ ì¶”ê°€
        //         profileImage.innerHTML = `<img src="${e.target.result}" alt="í”„ë¡œí•„ ì´ë¯¸ì§€">`;
        //         };

        //         reader.readAsDataURL(file);
        //     }
        // });

        /*
            ì•„ì´ë”” ì¤‘ë³µ í™•ì¸
        */
       //async - await ë™ê¸°ì‹
        async function checkId(alertEnabled = true) {
            const username = document.getElementById("username").value;

            // null ë˜ëŠ” undefined
            if (!username) {
                alert("ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”");
                return;
            }

            try {
                // ì•„ì´ë”” ì¤‘ë³µ í™•ì¸
                // fetch( URL, ì •ë³´ )
                // - ì •ë³´ : method, headers (í—¤ë”)
                const response = await fetch(`/check/${username}`, {
                    method: 'GET',
                    headers: {
                        'X-CSRF-TOKEN': csrfToken
                    }
                });

                if (response.ok) {
                    const result = await response.text();
                    let boxId = document.getElementById('box-id');
                    if (result === 'true') {
                        if(alertEnabled){
                            alert('ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤.');
                        }
                        boxId.classList.remove('needs-validation');
                        boxId.classList.add('was-validated');
                        return true;
                    } else {
                        alert('ì¤‘ë³µëœ ì•„ì´ë””ì…ë‹ˆë‹¤.');
                        boxId.classList.remove('was-validated');
                        boxId.classList.add('needs-validation');
                    }
                    return false;
                } else {
                    alert('ì•„ì´ë”” ì¤‘ë³µ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    return false;
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ì•„ì´ë”” ì¤‘ë³µ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                return false;
            }
        }


        /*
            ì œì¶œ í™•ì¸
            - ì•„ì´ë”” ì¤‘ë³µ ì²´í¬
        */
        async function checkSubmit(event) {
            event.preventDefault();                         // í¼ ì œì¶œ ë°©ì§€
            
            // ì•„ì´ë”” ì¤‘ë³µ ì²´í¬
            const isIdAvailable = await checkId(false);
            if (!isIdAvailable) {
                return;
            }

            // ë¹„ë°€ë²ˆí˜¸ í™•ì¸
            const isPasswordValid = validatePasswords();
            if (!isPasswordValid) {
                alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.');
                return;
            }
            alert('íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            document.getElementById("form").submit();   
        }


    </script>
</body>
</html>